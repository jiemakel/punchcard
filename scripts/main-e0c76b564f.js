var app;!function(e){"use strict";var t=angular.module("app",["http-auth-interceptor","ui.router","ui.bootstrap","ui.sortable"]);t.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/"),e.state("main",{url:"/?endpoint",templateUrl:"partials/main.html",controller:"MainController"})}])}(app||(app={}));var app;!function(e){"use strict";var t=function(){function e(e,t,r,n,a,s,o,l,p,i,c){this.id=e,this.label=t,this.resources=r,this.literals=n,this.statements=a,this.subjects=s,this.objects=o,this.objectsWithLabel=l,this.objectLabels=p,this.selectValue=i,this.selectLabel=c,this.exampleIds=[],this.examples=[]}return e}(),r=function(){function e(r,n,a,s,o){var l=this;this.$scope=r,this.$stateParams=n,this.$http=a,this.sparqlService=s,this.$timeout=o,r.endpoint=n.endpoint,r.labelLanguages="fi,sv,en",r.joinSeparator=";",r.constraints="  ",r.properties=[],r.propertiesQuery='PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX sf: <http://ldf.fi/functions#>\nSELECT ?property ?propertyLabel ?statements ?subjects ?objects ?objectsWithLabel ?objectLabels ?resources ?literals {\n  {\n    SELECT ?property (COUNT(?objectLabel) as ?objectsWithLabel) (COUNT(DISTINCT ?objectLabel) as ?objectLabels) (COUNT(*) AS ?objects) (MAX(?resource) AS ?resources) (MAX(?literal) AS ?literals) {\n      {\n        SELECT DISTINCT ?property ?object {\n          # CONSTRAINTS\n          # /CONSTRAINTS\n          ?s ?property ?object .\n        }\n      }\n      OPTIONAL {\n        # OLABELSELECTOR\n        # /OLABELSELECTOR\n      }\n      BIND(!ISLITERAL(?object) AS ?resource)\n      BIND(ISLITERAL(?object) AS ?literal)\n    }\n    GROUP BY ?property\n  }\n  {\n    SELECT ?property (COUNT(*) AS ?statements) (COUNT(DISTINCT ?s) AS ?subjects) {\n          # CONSTRAINTS\n          # /CONSTRAINTS\n          ?s ?property ?object .\n    }\n    GROUP BY ?property\n  }\n  OPTIONAL {\n    # PLABELSELECTOR\n    # /PLABELSELECTOR\n  }\n  BIND(COALESCE(?propertyLabelO,REPLACE(STR(?property),".*[/#]","")) AS ?propertyLabel)\n}\n',r.selectQuery="PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX sf: <http://ldf.fi/functions#>\nSELECT * {\n  # CONSTRAINTS\n  # /CONSTRAINTS\n  # OSELECTOR\n  # /OSELECTOR\n}\nGROUP BY ?s\n",r.$watch("labelLanguages",function(e){var t=e.split(/,\s*/);r.langSection="",t.forEach(function(e){return r.langSection+='"'+e+'" '});var n="\n    ?property sf:preferredLanguageLiteral (skos:prefLabel rdfs:label "+r.langSection+'"" ?propertyLabelO) .',a=r.propertiesQuery.split(/# \/?PLABELSELECTOR/);r.propertiesQuery=a[0]+"# PLABELSELECTOR"+n+"\n    # /PLABELSELECTOR"+a[2];var s="\n        ?object sf:preferredLanguageLiteral (skos:prefLabel "+r.langSection+'"" ?objectLabel) .';a=r.propertiesQuery.split(/# \/?OLABELSELECTOR/),r.propertiesQuery=a[0]+"# OLABELSELECTOR"+s+"\n        # /OLABELSELECTOR"+a[2]}),r.selectNonUniques=function(t){if(!t.nonUniqueObjects){t.nonUniqueObjects=[];var n=e.selectNonUniqueQuery;n=n.replace(/<PROPERTY>/g,l.sparqlService.bindingToString(t.id)),n=n.replace(/# CONSTRAINTS/g,r.constraints),n=n.replace(/# OLABELSELECTOR/g,"\n        ?object sf:preferredLanguageLiteral (skos:prefLabel "+r.langSection+'"" ?objectLabel) .'),l.sparqlService.query(r.endpoint,n).then(function(e){t.nonUniqueObjects=e.data.results.bindings.map(function(e){return l.sparqlService.bindingsToObject(e)})},function(e){console.log(e)})}};var p=function(e){void 0===e&&(e=!1);var t="",n="",a="",s={};r.selectQueryEditor&&(s=r.selectQueryEditor.getPrefixesFromQuery());var o={};for(var p in s)o[s[p]]=p;r.properties.filter(function(e){return e.selectLabel||e.selectValue}).forEach(function(s){s.subjects===s.statements||e?(t+=" ?"+s.label,a+=" ?"+s.label,s.selectValue&&s.selectLabel&&(t+=" ?"+s.label+"_id",a+=" ?"+s.label+"_id")):(t+=" (GROUP_CONCAT(DISTINCT ?"+s.label+"S;separator='"+r.joinSeparator+"') AS ?"+s.label+")",s.selectValue&&s.selectLabel&&(t+=" (GROUP_CONCAT(DISTINCT ?"+s.label+"_idS;separator='"+r.joinSeparator+"') AS ?"+s.label+"_id)")),s.subjects!==r.maxSubjects&&(n+="  OPTIONAL {\n  ");var p=s.id.value.replace(/(.*[\/#]).*/,"$1");n+=o[p]?"  ?s "+o[p]+":"+s.id.value.replace(/.*[\/#]/,"")+" ?"+s.label:"  ?s "+l.sparqlService.bindingToString(s.id)+" ?"+s.label,s.selectLabel?(n+="_id",s.subjects!==s.statements&&(n+="S"),n+=" .\n",s.subjects!==r.maxSubjects&&(n+="  "),s.objects!==s.objectsWithLabel&&(n+="  OPTIONAL {\n  ",s.subjects!==r.maxSubjects&&(n+="  ")),n+="  ?"+s.label+"_id",s.subjects!==s.statements&&(n+="S"),n+=" sf:preferredLanguageLiteral (skos:prefLabel "+r.langSection+' "" ?'+s.label,s.subjects!==s.statements&&(n+="S"),n+=") .\n",s.objects!==s.objectsWithLabel&&(s.subjects!==r.maxSubjects&&(n+="  "),n+="  }\n")):(s.subjects!==s.statements&&(n+="S"),n+=" .\n"),s.subjects!==r.maxSubjects&&(n+="  }\n")});var i=r.selectQuery.split(/  # \/?CONSTRAINTS/),c=i[0]+"  # CONSTRAINTS\n"+r.constraints.replace(/^\s+/gm,"  ")+"# /CONSTRAINTS"+i[2];return i=c.split(/  # \/?OSELECTOR/),c=i[0]+"  # OSELECTOR\n"+n+"  # /OSELECTOR"+i[2],c=c.replace(/SELECT.*{/,"SELECT (?s as ?id)"+t+" {"),c=t===a?c.replace(/#? ?GROUP BY.*/,"# GROUP BY ?s"):c.replace(/#? ?GROUP BY.*/,"GROUP BY ?s"+a)};r.$watch("properties",function(){r.selectQuery=p()},!0),r.$watch("selectQuery",function(e){e&&(r.selectQueryLink=r.endpoint+"?format=csv&query="+encodeURIComponent(e.replace(/ # .*/g,"").replace(/\s+/g," ")))}),r.shorten=function(){l.$http.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDtS96pmj2IeRdw81zobVDpCfs0rFphHvc",{longUrl:r.selectQueryLink}).then(function(e){r.selectQueryLink=e.data.id},function(e){console.log(e)})},r.setResults=function(e){r.constraints=r.propertiesQuery.split(/# \/?CONSTRAINTS/)[1],r.maxSubjects=0,r.properties=[],e.responseJSON.results.bindings.forEach(function(e){var n=parseInt(e.subjects.value,10);n>r.maxSubjects&&(r.maxSubjects=n),r.properties.push(new t(e.property,e.propertyLabel.value.replace(/ä/g,"a").replace(/ö/g,"o").replace(/Ä/g,"A").replace(/Ö/g,"O").replace(/\W/g,"_"),"true"===e.resources.value,"true"===e.literals.value,parseInt(e.statements.value,10),n,parseInt(e.objects.value,10),parseInt(e.objectsWithLabel.value,10),parseInt(e.objectLabels.value,10),"true"===e.resources.value&&parseInt(e.objects.value,10)===parseInt(e.objectLabels.value,10)?!1:!0,"true"===e.resources.value&&"0"!==e.objectLabels.value))}),o(function(){return r.selectQueryEditor.addPrefixes(r.propertiesQueryEditor.getPrefixesFromQuery())}),r.$digest(),o(function(){r.selectQuery=p(),l.sparqlService.query(r.endpoint,p(!0)+"LIMIT 5").then(function(e){e.data.results.bindings.map(function(e){return l.sparqlService.bindingsToObject(e)}).forEach(function(e){r.properties.forEach(function(t){t.selectLabel&&t.selectValue&&t.exampleIds.push(e[t.label+"_id"]),t.examples.push(e[t.label])})})},function(e){console.log(e)})})}}return e.$inject=["$scope","$stateParams","$http","sparqlService","$timeout"],e.$componentName="MainController",e.selectNonUniqueQuery="PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX sf: <http://ldf.fi/functions#>\nPREFIX foaf: <http://xmlns.com/foaf/0.1/>\nSELECT ?objectLabel (COUNT(*) AS ?objects) {\n  {\n    SELECT DISTINCT ?object {\n      # CONSTRAINTS\n      ?s <PROPERTY> ?object .\n    }\n  }\n  # OLABELSELECTOR\n}\nGROUP BY ?objectLabel\nHAVING (?objects>1)\n",e}();angular.module("app").controller("MainController",r),e.MainController=r}(app||(app={}));var app;!function(e){"use strict";var t=function(){function e(e,t){this.$http=e,this.$q=t}return e.$inject=["$http","$q"],e.$componentName="sparqlService",e.prototype.check=function(e,t){var r=this.$q.defer();return this.$http(angular.extend({method:"GET",url:e,params:{query:"ASK {}"},headers:{Accept:"application/sparql-results+json"}},t)).then(function(e){return r.resolve(e.data["boolean"]===!0)},function(e){return r.resolve(!1)}),r.promise},e.prototype.checkUpdate=function(e,t){var r=this.$q.defer();return this.$http(angular.extend({method:"POST",url:e,headers:{"Content-Type":"application/sparql-update"},data:"INSERT DATA {}"},t)).then(function(e){return r.resolve(204===e.status)},function(e){return r.resolve(!1)}),r.promise},e.prototype.checkRest=function(e,t){var r=this.$q.defer();return this.$http(angular.extend({method:"POST",url:e+"?default",data:"",headers:{"Content-Type":"text/turtle"}},t)).then(function(e){return r.resolve(204===e.status)},function(e){return r.resolve(!1)}),r.promise},e.prototype.get=function(e,t,r){return this.$http(angular.extend({method:"GET",url:e,params:null!==t?{graph:t}:{"default":""},headers:{Accept:"text/turtle"}},r))},e.prototype.post=function(e,t,r,n){return this.$http(angular.extend({method:"POST",url:e,params:null!=r?{graph:r}:{"default":""},data:t,headers:{"Content-Type":"text/turtle"}},n))},e.prototype.put=function(e,t,r,n){return this.$http(angular.extend({method:"PUT",url:e,params:null!=r?{graph:r}:{"default":""},data:t,headers:{"Content-Type":"text/turtle"}},n))},e.prototype["delete"]=function(e,t,r){return this.$http(angular.extend({method:"DELETE",url:e,params:null!=t?{graph:t}:{"default":""}},r))},e.prototype.query=function(e,t,r){return t.length<=2048?this.$http(angular.extend({method:"GET",url:e,params:{query:t},headers:{Accept:"application/sparql-results+json"}},r)):this.$http(angular.extend({method:"POST",url:e,data:t,headers:{"Content-Type":"application/sparql-query",Accept:"application/sparql-results+json"}},r))},e.prototype.construct=function(e,t,r){return t.length<=2048?this.$http(angular.extend({method:"GET",url:e,params:{query:t},headers:{Accept:"text/turtle"}},r)):this.$http(angular.extend({method:"POST",url:e,data:t,headers:{"Content-Type":"application/sparql-query",Accept:"text/turtle"}},r))},e.prototype.update=function(e,t,r){return this.$http(angular.extend({method:"POST",url:e,headers:{"Content-Type":"application/sparql-update"},data:t},r))},e.prototype.stringToSPARQLString=function(e){return'"'+e.replace(/"/g,'\\"')+'"'},e.prototype.bindingsToObject=function(e){var t={};for(var r in e)t[r]=this.bindingToValue(e[r]);return t},e.prototype.bindingToValue=function(e){if(null!=e){if("uri"===e.type)return e.value;if("bnode"===e.type)return e.value;if(null!==e.datatype)switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#integer":case"http://www.w3.org/2001/XMLSchema#decimal":return parseInt(e.value,10);case"http://www.w3.org/2001/XMLSchema#float":case"http://www.w3.org/2001/XMLSchema#double":return parseFloat(e.value);case"http://www.w3.org/2001/XMLSchema#boolean":return e.value?!0:!1}return e.value}},e.prototype.bindingToString=function(e){if(null==e)return"UNDEF";var t=e.value.replace(/\\/g,"\\\\").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\"/g,'\\"').replace(/\'/g,"\\'");if("uri"===e.type)return"<"+t+">";if("bnode"===e.type)return"_:"+t;if(null===e.datatype)return e["xml:lang"]?'"'+t+'"@'+e["xml:lang"]:'"'+t+'"';switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#integer":case"http://www.w3.org/2001/XMLSchema#decimal":case"http://www.w3.org/2001/XMLSchema#double":case"http://www.w3.org/2001/XMLSchema#boolean":return t;case"http://www.w3.org/2001/XMLSchema#string":return'"'+t+'"';default:return'"'+t+'"^^<'+e.datatype+">"}},e}();angular.module("app").service("sparqlService",t),e.SparqlService=t}(app||(app={}));var app;!function(e){"use strict";var t=function(){function e(e){var t=this;this.$timeout=e,this.restrict="E",this.scope={data:"=",endpoint:"=",callback:"=",yasqe:"="},this.link=function(e,r,n){var a=YASQE(r[0],{createShareLink:!1,sparql:{callbacks:{complete:e.callback},showQueryButton:e.callback?!0:!1}});e.yasqe=a,a.on("change",function(){return t.$timeout(function(){return e.data=a.getValue()})}),e.$watch("data",function(e,t){e&&e!==a.getValue()&&a.setValue(e)}),e.$watch("endpoint",function(e){e&&(a.options.sparql.endpoint=e)})}}return e.$inject=["$timeout"],e.$componentName="yasqe",e}();angular.module("app").directive("yasqe",["$timeout",function(){return new(Function.prototype.bind.apply(t,[null].concat(Array.prototype.slice.call(arguments))))}]),e.YasqeDirective=t}(app||(app={}));var app;!function(e){"use strict";var t=function(){function e(e){this.$timeout=e,this.restrict="E",this.scope={data:"=",prefixes:"="},this.link=function(e,t,r){var n=YASR(t[0],{getUsedPrefixes:e.prefixes});e.$watch("data",function(e,t){e&&n.setResponse(e)})}}return e.$inject=["$timeout"],e.$componentName="yasr",e}();angular.module("app").directive("yasr",["$timeout",function(){return new(Function.prototype.bind.apply(t,[null].concat(Array.prototype.slice.call(arguments))))}]),e.YasrDirective=t}(app||(app={})),function(e){try{e=angular.module("app")}catch(t){e=angular.module("app",[])}e.run(["$templateCache",function(e){e.put("partials/main.html",'\n<script type="text/ng-template" id="popover.html">\n  <ul>\n    <li ng-repeat="object in property.nonUniqueObjects">{{object.objectLabel}}:&nbsp;{{object.objects}}</li>\n  </ul>\n</script>\n<div class="container">\n  <h4>Punchcard</h4>\n  <div class="form-group">\n    <label>Endpoint</label>\n    <input type="text" ng-model="endpoint" class="form-control"/>\n  </div>\n  <div class="form-group">\n    <label>Label language preference order</label>\n    <input type="text" ng-model="labelLanguages" class="form-control"/>\n  </div>\n  <div class="form-group">\n    <label>Join multiple values using</label>\n    <input type="text" ng-model="joinSeparator" class="form-control"/>\n  </div>\n  <yasqe yasqe="propertiesQueryEditor" data="propertiesQuery" endpoint="endpoint" callback="setResults"></yasqe>\n  <table class="table table-striped table-hover table-condensed">\n    <tr ui-sortable="ui-sortable" ng-model="properties">\n      <th ng-repeat="property in properties">\n        <input style="min-width:12rem" ng-model="property.label" class="input-sm form-control"/>\n        <div class="checkbox">\n          <label>\n            <input type="checkbox" ng-model="property.selectValue"/>V\n          </label>\n        </div>\n        <div ng-show="property.resources &amp;&amp; property.objectLabels!=0" class="checkbox">\n          <label>\n            <input type="checkbox" ng-model="property.selectLabel"/>L\n          </label>\n        </div><span ng-mouseenter="selectNonUniques(property)" popover-placement="right" popover-trigger="mouseenter" uib-popover-template="\'popover.html\'" ng-show="property.objectLabels != property.objects &amp;&amp; property.resources" class="label label-warning">{{property.objects - property.objectLabels}}</span><span ng-show="property.subjects != property.statements" class="label label-info">{{property.statements - property.subjects}}</span>\n      </th>\n    </tr>\n    <tr ng-repeat="dummy in properties[0].examples track by $index">\n      <td ng-repeat="property in properties">{{property.examples[$parent.$index] | limitTo: 40 }}{{property.examples[$parent.$index].length > 40 ? \'...\' : \'\'}} </td>\n    </tr>\n  </table>\n  <yasqe yasqe="selectQueryEditor" data="selectQuery"></yasqe><span ng-click="shorten()" class="glyphicon glyphicon-share-alt"></span><a ng-href="{{selectQueryLink}}">{{selectQueryLink}}</a>\n</div>')}])}();